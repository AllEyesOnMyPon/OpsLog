groups:
  - name: logops.alerts
    interval: 15s   # jak często Prometheus ma ewaluować te reguły

    rules:
      # 1) Gateway nie odpowiada / scrape przestał działać
      - alert: LogOpsGatewayDown
        expr: up{job="logops_gateway"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gateway is down"
          description: "Target up{job='logops_gateway'} == 0 przez ≥1m."

      # 2) Brak ingestu w ogóle (twarde zero)
      - alert: LogOpsNoIngest5m
        expr: increase(logops_accepted_total[5m]) <= 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "No logs ingested for 5 minutes"
          description: "Brak przyrostu logops_accepted_total w oknie 5m przez ≥2m."

      # 3) Niski ingest – ruch 'tli się', ale jest podejrzanie mały
      #    (średnio < 0.2 loga/s przez ≥5m)
      - alert: LogOpsLowIngest
        expr: rate(logops_accepted_total[5m]) < 0.2
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Low ingest rate"
          description: "Średnia szybkość ingestu < 0.2 loga/s przez ≥5m."

      # 4) Nagły burst ingestu — możliwy sztorm zdarzeń / pętla / DDoS na wejściu
      #    (średnio > 20 logów/s przez ≥1m)
      - alert: LogOpsHighIngestBurst
        expr: rate(logops_accepted_total[1m]) > 20
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High ingest burst"
          description: "Szybkość ingestu > 20 logów/s przez ≥1m (sprawdź źródła)."

      # 5) Duży udział brakujących timestampów (wariant WARNING)
      #    Aktywuj dopiero, gdy w ostatnich 5m zebraliśmy min. 100 logów,
      #    a odsetek braków TS > 20% przez ≥2m.
      - alert: LogOpsHighMissingTS
        expr: increase(logops_accepted_total[5m]) >= 100
          and ( increase(logops_missing_ts_total[5m])
                / clamp_min(increase(logops_accepted_total[5m]), 1) ) > 0.20
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High share of missing timestamps"
          description: "Udział braków TS > 20% przy ≥100 logach w 5m."

      # 6) Duży udział brakujących timestampów (wariant CRITICAL)
      - alert: LogOpsVeryHighMissingTS
        expr: increase(logops_accepted_total[5m]) >= 200
          and ( increase(logops_missing_ts_total[5m])
                / clamp_min(increase(logops_accepted_total[5m]), 1) ) > 0.50
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Very high share of missing timestamps"
          description: "Udział braków TS > 50% przy ≥200 logach w 5m."

      # 7) Duży udział brakujących leveli (WARNING)
      - alert: LogOpsHighMissingLevel
        expr: increase(logops_accepted_total[5m]) >= 100
          and ( increase(logops_missing_level_total[5m])
                / clamp_min(increase(logops_accepted_total[5m]), 1) ) > 0.20
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High share of missing levels"
          description: "Udział braków level > 20% przy ≥100 logach w 5m."

      # 8) Duży udział brakujących leveli (CRITICAL)
      - alert: LogOpsVeryHighMissingLevel
        expr: increase(logops_accepted_total[5m]) >= 200
          and ( increase(logops_missing_level_total[5m])
                / clamp_min(increase(logops_accepted_total[5m]), 1) ) > 0.50
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Very high share of missing levels"
          description: "Udział braków level > 50% przy ≥200 logach w 5m."

      # 9) Kolejka przetwarzania urosła i się utrzymuje (możliwy backpressure)
      - alert: LogOpsInflightStuckHigh
        expr: logops_inflight > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Inflight gauge high"
          description: "logops_inflight > 5 przez ≥2m (przeciążenie lub zator)."

      # 10) Brak jakichkolwiek metryk z joba (absent) – sygnał na wypadek utraty scrape’a
      - alert: LogOpsMetricsAbsent
        expr: absent(up{job="logops_gateway"})
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "No metrics scraped from gateway"
          description: "Prometheus nie widzi żadnych metryk z job='logops_gateway' przez ≥2m."
