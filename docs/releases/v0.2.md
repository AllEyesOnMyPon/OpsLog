# LogOps v0.2 – Housekeeping & Observability

---

## Highlights
- **Housekeeping module** – retencja i archiwizacja plików NDJSON.
- **Autorun housekeeping** w gatewayu (przy starcie / cyklicznie).
- **Observability stack (Docker)**: Promtail + Loki + Prometheus + Grafana.
- **Alerting (Prometheus rules)**: dostępność, wolumen, jakość logów, kolejka.
- **Rozdzielenie requirements**: produkcyjne (`requirements.txt`) vs developerskie (`requirements-dev.txt`).
- **Dokumentacja**: modularny podział (`overview`, `infra`, `observability`, `tools/housekeeping`, `architecture`).
- **Structurizr Lite** – diagramy C1–C3 w `docs/architecture.md`.

---

## Details

### Housekeeping
- Nowy skrypt `tools/housekeeping.py`:
  - czyta `.env` (`LOGOPS_RETENTION_DAYS`, `LOGOPS_ARCHIVE_MODE`, `LOGOPS_SINK_DIR`),
  - tryb `delete` – usuwa stare pliki,
  - tryb `zip` – pakuje stare pliki do `data/archive/` i usuwa źródło.
- Gateway integruje housekeeping przez lifespan:
  - `LOGOPS_HOUSEKEEP_AUTORUN=true` → uruchamia się przy starcie,
  - `LOGOPS_HOUSEKEEP_INTERVAL_SEC` > 0 → cyklicznie co N sekund.

### Observability stack (Docker)
- Nowa struktura `infra/docker/` → każdy serwis ma własny katalog (`prometheus/`, `loki/`, `promtail/`).
- **Promtail**: NDJSON parser, utrwalanie offsetów (`promtail-data`), `start_position: end`.
- **Loki**: własny wolumen `loki-data`, poprawione ścieżki configu.
- **Prometheus**: scrape gatewaya i self-metrics, dodany `alert_rules.yml`.
- **Grafana**: dashboardy „Overview”, „Trends”, „Emitters”, „Live tail”.

### Alerting (Prometheus)
Nowe reguły w `infra/docker/prometheus/alert_rules.yml`:
- **Gateway availability**: `LogOpsGatewayDown`, `LogOpsMetricsAbsent`.
- **Traffic volume**: `LogOpsNoIngest5m`, `LogOpsLowIngest`, `LogOpsHighIngestBurst`.
- **Data quality**: `LogOpsHighMissingTS`, `LogOpsVeryHighMissingTS`, analogiczne dla `level`.
- **System health**: `LogOpsInflightStuckHigh`.

### Dependencies
- `services/ingest_gateway/requirements.txt`: core packages (FastAPI, Uvicorn, dotenv, cryptography, prometheus-client, requests).
- `requirements-dev.txt`: dev tooling (black, ruff, mypy, pytest, httpx).

### Documentation
- Podział dokumentacji na mniejsze pliki (`docs/overview.md`, `docs/quickstart.md`, `docs/infra.md`, `docs/observability.md`, `docs/tools/housekeeping.md`, `docs/architecture.md`).
- Dodanie diagramów C1–C3 (Structurizr Lite + PNG).

---

## Known Issues
- Housekeeping działa, ale **zip mode** wymaga jeszcze walidacji dla dużych datasetów.
- Brak dashboardu stricte pod housekeeping metrics (planowane w kolejnych wersjach).
- Alerty mają progi eksperymentalne – mogą wymagać strojenia na realnym ruchu.
---

