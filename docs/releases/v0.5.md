# LogOps v0.5 ‚Äî Core split, Orchestration CLI, tooling & docs refresh

## Highlights
- **Wydzielenie Core** (FastAPI) z Ingest: nowe `/v1/logs` z metrykami, bez normalizacji; opcjonalny **NDJSON sink** po stronie Core.
- **Ingest ‚áí Core**: Ingest normalizuje i **forwarduje** do Core (HTTP), ma w≈Çasne metryki i (opcjonalnie) lokalny sink.
- **Orchestrator CLI (`orch_cli.py`)**: prosty klient HTTP do listowania/uruchamiania/zatrzymywania scenariuszy.
- **Nowe narzƒôdzia**:
  - `verify_hmac_against_signer.py` ‚Äî offline weryfikacja podpisu HMAC (obs≈Çuga nag≈Ç√≥wk√≥w X-Api-* i legacy X-Logops-*).
  - Usprawnienia `sign_hmac.py` i `hmac_curl.sh` (patrz ni≈ºej).
- **Infra/observability**: od≈õwie≈ºone Compose, nowe mounty Promtail (logi/scenariusze), ujednolicone README.
- **Dokumentacja**: sp√≥jne README dla **Core, Ingest, AuthGW, Tools, Infra/Observability**, nowy **Quickstart** z `make demo`.

---

## Zmiany per komponent

### üîπ Core (NOWY serwis)
- Endpointy: `/healthz`, `/metrics`, `POST /v1/logs`.
- Metryki:
  - `core_inflight` *(Gauge)*,
  - `core_request_latency_seconds{emitter,scenario_id}` *(Histogram)*,
  - `core_accepted_total{emitter,scenario_id}` *(Counter)*,
  - `core_level_total{level}` *(Counter)*,
  - `core_bytes_total` *(Counter)*,
  - `core_rejected_total{reason}` *(Counter: `too_large`, `too_many_items`)*.
- Debug: `/_debug/hdrs`, `/_debug/stats` (ring-buffer ostatnich rekord√≥w).
- Konfiguracja:
  - `CORE_MAX_BODY_BYTES` (domy≈õlnie `1 MiB`), `CORE_MAX_ITEMS` (5000),
  - `CORE_SINK_FILE` (domy≈õlnie `false`), `CORE_SINK_DIR` (dziedziczy `LOGOPS_SINK_DIR`),
  - priorytet ≈õcie≈ºek: `LOGOPS_SINK_DIR` ‚Üí `CORE_SINK_DIR` ‚Üí `./data/ingest`.

### üîπ Ingest (refactor)
- Normalizacja rekord√≥w (ts/level/PII) jak dotƒÖd.
- **Forward do Core** (`CORE_URL`, domy≈õlnie `http://127.0.0.1:8095/v1/logs`) z nag≈Ç√≥wkami transportowymi (`X-Emitter`, `X-Scenario-Id`).
- Metryki pozosta≈Çy bez zmian (batch size/latency, missing_ts/level, parse_errors, ingested/accepted).
- Opcjonalny **NDJSON sink** po stronie Ingest: mo≈ºna mieƒá **sink w Ingest, Core, w obu lub w ≈ºadnym** (flagi `LOGOPS_SINK_FILE` / `CORE_SINK_FILE`).

### üîπ AuthGW (doprecyzowania + poprawki)
- **Retry + circuit breaker** realizowane przez wydzielony modu≈Ç `downstream.py` (exponential backoff, half-open).
- **Backpressure** nadal przed forwardem (413 + `X-Backpressure-Reason`).
- **Poprawka lintera (ruff UP038)**: u≈ºycie `numbers.Real` zamiast `isinstance(x, (int, float))`.
- Metryki: `auth_requests_total{status,emitter,scenario_id}`, `auth_request_latency_seconds`, `logops_rejected_total{reason,emitter}`.

### üîπ Orkiestracja
- **Nowy** `orch_cli.py`:
  - `list` ‚Äî `/scenario/list`,
  - `start` ‚Äî `/scenario/start` (obs≈Çuga `--name`, `--yaml-path`, `--inline`, `--seed`, `--dry-run`, `--debug`, `--strict`, `--step-timeout`),
  - `stop` ‚Äî `/scenario/stop`.
  - Domy≈õlny BASE: `http://127.0.0.1:8070`.
- **Runner scenariuszy (`tools/run_scenario.py`)**:
  - Stabilizacja EPS: rzutowanie `--eps` do **int** (emitery tego wymagajƒÖ),
  - bogatsze ticki (bez zmian w formacie z v0.4), obs≈Çuga `SIGINT`.

### üîπ Tools (HMAC & diagnostyka)
- `sign_hmac.py`:
  - **Kanonikalizacja BEZ query string**: `METHOD\nPATH_ONLY\nSHA256(body)\nX-Timestamp\nX-Nonce?`.
  - Opcje: `--nonce` (auto), `--ts`, `--ts-offset`, `--body-file`, `--one-per-line`.
- `hmac_curl.sh`:
  - domy≈õlne URL/klucze z ENV (`ENTRYPOINT_URL`, `LOGOPS_API_KEY`, `LOGOPS_SECRET`),
  - sensowne domy≈õlne `Content-Type` (tylko gdy wysy≈Çasz body i nie nadpisujesz),
  - `--echo-headers` zwraca gotowe `-H "K: V"` w jednej linii.
- **NOWY** `verify_hmac_against_signer.py`:
  - wczytuje nag≈Ç√≥wki z `stdin` (np. output `--echo-headers`),
  - liczy podpis na podstawie **sekretu z ENV** `LOGOPS_SECRET` i pliku body,
  - wspiera **dwa style** nag≈Ç√≥wk√≥w: aktualny `X-Api-*` (b64) i legacy `X-Logops-*` (hex).

### üîπ Infra / Observability
- Compose od≈õwie≈ºony: Prometheus/Alertmanager/Grafana najnowsze stabilne, Loki/Promtail 2.9.0.
- **Promtail**: dodatkowe bind-mounty hosta:
  - `../../../data/ingest ‚Üí /var/log/logops:ro` (NDJSON),
  - `../../../logs ‚Üí /var/log/logops-hosts/logs:ro`,
  - `../../../data/orch/scenarios ‚Üí /var/log/logops-hosts/scenarios:ro`.
- Dokumenty **infra.md** i **observability.md** zaktualizowane (≈õcie≈ºki, start/stop, alerty SLO/p95).

### üîπ Dokumentacja & Quickstart
- Sp√≥jne README: **Core, Ingest, AuthGW, Tools, Infra/Observability**.
- **Quickstart** z trybem **`make demo`** (podnosi stack i generuje ruch).
- **Overview** odchudzone; pe≈Çne linki w README g≈Ç√≥wnym.

---

## Breaking changes / uwagi kompatybilno≈õci
- **HMAC canonical path**: od v0.5 podpis liczymy **bez query string** (tylko `PATH_ONLY`).
  Je≈ºeli masz w≈Çasnych klient√≥w z wcze≈õniejszƒÖ kanonikalizacjƒÖ `PATH+QUERY`, zaktualizuj je lub u≈ºyj `sign_hmac.py`.
- **Sink NDJSON**: mo≈ºesz mieƒá aktywny sink w Ingest **i/lub** w Core. Upewnij siƒô, ≈ºe Promtail patrzy na katalog u≈ºywany przez wybrany sink (`LOGOPS_SINK_DIR` / `CORE_SINK_DIR`).
- **Promtail mounty**: zmieni≈Çy siƒô ≈õcie≈ºki bind-mount; dopasuj je do uk≈Çadu repo, je≈õli masz lokalne r√≥≈ºnice.

---

## Szybki sanity-check v0.5
```bash
# 1) Stack observability
docker compose -f infra/docker/docker-compose.observability.yml up -d

# 2) Serwisy
uvicorn services.ingest.app:app --port 8080 --reload &
uvicorn services.core.app:app   --port 8095 --reload &
uvicorn services.authgw.app:app --port 8081 --reload &   # opcjonalnie

# 3) Ruch testowy (scenariusz)
python tools/run_scenario.py -s scenarios/spike.yaml

# 4) Loki ‚Äì powinny wpadaƒá logi
curl -G "http://localhost:3100/loki/api/v1/query" \
  --data-urlencode 'query={job="logops-ndjson",app="logops"}' | jq .

# 5) Prometheus ‚Äì metryki Core/Ingest/AuthGW
open http://localhost:9090
```

---

## Zmienne `.env` (przydatne w v0.5)
- Endpoints: `ENTRYPOINT_URL` (AuthGW), `INGEST_URL`, `CORE_URL`, `PROM_URL`, `LOKI_URL`.
- HMAC demo: `LOGOPS_API_KEY`, `LOGOPS_SECRET`.
- Sink/retencja: `LOGOPS_SINK_FILE`, `LOGOPS_SINK_DIR`, `LOGOPS_RETENTION_DAYS`, `LOGOPS_ARCHIVE_MODE`.
- Housekeeping: `LOGOPS_HOUSEKEEP_AUTORUN`, `LOGOPS_HOUSEKEEP_INTERVAL_SEC`.
- PII (je≈õli u≈ºywasz): `LOGOPS_SECRET_KEY`, `LOGOPS_ENCRYPT_PII`, `LOGOPS_ENCRYPT_FIELDS`.
- Alerty: `ALERTMANAGER_SLACK_WEBHOOK`, `ALERTMANAGER_SLACK_WEBHOOK_LOGOPS`.

---

## Podsumowanie
Wersja **v0.5** porzƒÖdkuje architekturƒô: **Core** oddziela przyjƒôcie log√≥w i metryki od **Ingest** (normalizacji), co upraszcza skalowanie i odpowiedzialno≈õci. Dodali≈õmy **Orchestrator CLI**, nowe narzƒôdzia HMAC i znaczƒÖco ujednolicili≈õmy dokumentacjƒô oraz infra.
Zmiana kanonikalizacji HMAC (bez query) to **najwa≈ºniejsza uwaga kompatybilno≈õci** ‚Äî skontroluj klient√≥w.
