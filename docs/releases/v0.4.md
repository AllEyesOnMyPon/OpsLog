# LogOps v0.4 â€” AuthGW, HMAC & narzÄ™dzia deweloperskie

## Highlights
- **Nowy komponent: Auth Gateway (FastAPI)** â€” autoryzacja i rate limiting przed Ingest Gateway.
- **HMAC podpisy**: obsÅ‚uga `X-Api-Key`, `X-Timestamp`, `X-Content-SHA256`, `X-Signature`, opcjonalnie `X-Nonce` (anty-replay).
- **Rate limiting (Token Bucket)** â€” per-emitter, global default + override, Redis optional.
- **Circuit breaker + retry** (downstream) â€” exponential backoff, half-open window.
- **Backpressure** â€” limity wielkoÅ›ci payloadu i liczby elementÃ³w, 413 + metryki `logops_rejected_total`.
- **NarzÄ™dzia deweloperskie**:
  - `tools/sign_hmac.py` â€” generacja nagÅ‚Ã³wkÃ³w HMAC (symulacje replay, zÅ‚ego sekreta, zÅ‚ego body, skew timestamp).
  - `tools/hmac_curl.sh` â€” wrapper nad `curl`, automatyczne podpisywanie requestÃ³w, tryb `--echo-headers`.
- **run_scenario.py v2** â€” spÃ³jny JSONL (scenario.start/tick/scenario.end), peÅ‚ne metadane tickÃ³w (eps, jitter, schedule).
- **Config YAML dla AuthGW** â€” demo klucze (`demo-pub-1`, `demo-pub-2`) i forward do Ingest.
- **ObsÅ‚uga SIGINT** w orchestratorze â€” graceful stop, kompletne logi.
- **SLO i latency** â€” metryki `logops_request_latency_seconds` (histogram), monitoring p95 w Prometheusie, alerty dla degradacji.

---

## Zrealizowane milestoneâ€™y

### ðŸ”¹ Emitery i scenariusze
- [x] Rozszerzone ticki: `base_eps`, `eff_eps`, `jitter_scale`, `schedule` (peÅ‚ny opis ramp/jitter).
- [x] Logi JSONL: `scenario.start`, `tick`, `scenario.end` z `ts` (epoch) i `ts_iso` (UTC ISO-8601).
- [x] `dry-run` â€” loguje ticki bez uruchamiania subprocessÃ³w.
- [x] ObsÅ‚uga `SIGINT` â€” stop po bieÅ¼Ä…cym ticku, kompletne domkniÄ™cie logu.

### ðŸ”¹ Auth Gateway
- [x] `app.py`: FastAPI, healthcheck `/healthz`, endpoint `/ingest` â†’ forward do Ingest Gateway.
- [x] `hmac_mw.py`: walidacja nagÅ‚Ã³wkÃ³w HMAC, anty-replay (`X-Nonce`, Redis).
- [x] `ratelimit_mw.py`: Token Bucket, domyÅ›lne i per-emitter.
- [x] `downstream.py`: retry + breaker (failure threshold, half-open, exponential backoff).
- [x] Konfiguracja YAML (`config.example.yaml`): auth, forward, ratelimit, secrets.
- [x] Demo klucze: `demo-pub-1/demo-priv-1`, `demo-pub-2/demo-priv-2`.

### ðŸ”¹ NarzÄ™dzia developerskie
- [x] `tools/sign_hmac.py`: podpisywanie requestÃ³w, opcje `--nonce`, `--ts`, `--ts-offset`, `--body-file`.
- [x] `tools/hmac_curl.sh`: wrapper curl, automatyczne podpisy, integracja z ENV i sign_hmac.py.
- [x] Negatywne testy: zÅ‚y sekret, zÅ‚e body, stary timestamp, replay nonce â†’ `401`.
- [x] Pozytywne testy: poprawne HMAC + nonce â†’ `200` OK, forward.

### ðŸ”¹ Observability & telemetry
- [x] `logops_rejected_total{reason=...,emitter=...}` â€” backpressure.
- [x] Telemetria ingest_req (IP, emitter, UA, payload size).
- [x] Statystyki circuit breaker (logi).
- [x] **Latency histograms** (`logops_request_latency_seconds`) + SLO p95.
- [x] **Alerty Prometheus**: degradacja p95 (np. >500 ms przez â‰¥2m).

---

## Szybki sanity-check

```bash
# AuthGW health
curl -s http://localhost:8090/healthz | jq

# Generacja nagÅ‚Ã³wkÃ³w HMAC (headers only)
tools/hmac_curl.sh --nonce -d '{"msg":"hello"}' --echo-headers

# Poprawny request (200 OK)
tools/hmac_curl.sh --nonce -d '{"msg":"ok"}' -- -i -s -o /dev/null -w "%{http_code}\n"

# Negatywny test â€” zÅ‚y sekret
LOGOPS_SECRET="wrong" tools/hmac_curl.sh --nonce -d '{"msg":"bad"}' -- -i -s -o /dev/null -w "%{http_code}\n"

# Rate limiting (2 szybkie requesty â†’ 200, potem 429)
make rl-hit

# Backpressure (payload >200kB â†’ 413)
make bp-big

# SprawdÅº histogram latency
curl -s http://localhost:8090/metrics | grep logops_request_latency_seconds
```

---

## WaÅ¼ne zmienne `.env`

- `LOGOPS_ENCRYPT_PII`, `LOGOPS_SECRET_KEY` (Fernet)
- `LOGOPS_SINK_FILE`, `LOGOPS_SINK_DIR`
- `LOGOPS_RETENTION_DAYS`, `LOGOPS_ARCHIVE_MODE`
- `LOGOPS_HOUSEKEEP_AUTORUN`, `LOGOPS_HOUSEKEEP_INTERVAL_SEC`
- `LOGOPS_API_KEY`, `LOGOPS_SECRET` (demo/test)
- `ALERTMANAGER_SLACK_WEBHOOK`, `ALERTMANAGER_SLACK_WEBHOOK_LOGOPS`

---

## Podsumowanie

ðŸš€ **v0.4** wprowadza kompletny **Auth Gateway** z obsÅ‚ugÄ… **HMAC, rate limiting, backpressure oraz metrykami latency (p95 SLO)**.
Nowe narzÄ™dzia deweloperskie (`sign_hmac.py`, `hmac_curl.sh`) umoÅ¼liwiajÄ… wygodne testowanie i symulowanie ruchu.
Scenariusze w `run_scenario.py` zyskaÅ‚y peÅ‚nÄ… telemetriÄ™ i spÃ³jny format logÃ³w.

To wydanie domyka MVP dla bezpieczeÅ„stwa i niezawodnoÅ›ci pipelineâ€™u LogOps.
